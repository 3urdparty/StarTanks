using System;
using System.Collections.Generic;
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Content;
using Microsoft.Xna.Framework.Graphics;
using MonoGameLibrary;
using MonoGameLibrary.Graphics;
using nkast.Aether.Physics2D.Dynamics;
using AetherVector2 = nkast.Aether.Physics2D.Common.Vector2;

namespace SpaceTanks
{
    public class Platform : GameObject
    {
        private readonly ContentManager _content;
        private TextureAtlas _atlas;

        // Tile regions - 3x3 grid
        private TextureRegion _tile00;
        private TextureRegion _tile01;
        private TextureRegion _tile02;
        private TextureRegion _tile10;
        private TextureRegion _tile11;
        private TextureRegion _tile12;
        private TextureRegion _tile20;
        private TextureRegion _tile21;
        private TextureRegion _tile22;

        // Platform tile data
        private int[,] _platformTiles;
        private int _platformWidth;
        private int _platformHeight;
        private int _tileSize = 32;

        // Tile type constants
        private const int Empty = 0;
        private const int Tile00 = 1;
        private const int Tile01 = 2;
        private const int Tile02 = 3;
        private const int Tile10 = 4;
        private const int Tile11 = 5;
        private const int Tile12 = 6;
        private const int Tile20 = 7;
        private const int Tile21 = 8;
        private const int Tile22 = 9;

        // Physics
        public Body PhysicsBody { get; set; }

        public Platform(ContentManager content, int width, int height, int tileSize = 32)
        {
            _content = content;
            LoadTiles();

            CreatePlatform(width, height, tileSize);
        }

        private void LoadTiles()
        {
            _atlas = TextureAtlas.FromFile(_content, "tilemap-atlas.xml");

            _tile00 = _atlas.GetRegion("00");
            _tile01 = _atlas.GetRegion("01");
            _tile02 = _atlas.GetRegion("02");
            _tile10 = _atlas.GetRegion("10");
            _tile11 = _atlas.GetRegion("11");
            _tile12 = _atlas.GetRegion("12");
            _tile20 = _atlas.GetRegion("20");
            _tile21 = _atlas.GetRegion("21");
            _tile22 = _atlas.GetRegion("22");
        }

        /// <summary>
        /// Create a rectangular platform at the given position with the specified dimensions.
        /// </summary>
        public void CreatePlatform(int platformWidth, int platformHeight, int tileSize = 32)
        {
            _tileSize = tileSize;
            _platformWidth = platformWidth;
            _platformHeight = platformHeight;

            // Create tile map for the platform
            _platformTiles = new int[platformWidth, platformHeight];

            for (int x = 0; x < platformWidth; x++)
            {
                for (int y = 0; y < platformHeight; y++)
                {
                    bool isLeft = (x == 0);
                    bool isRight = (x == platformWidth - 1);
                    bool isTop = (y == 0);
                    bool isBottom = (y == platformHeight - 1);

                    if (isTop && isLeft)
                        _platformTiles[x, y] = Tile00;
                    else if (isTop && isRight)
                        _platformTiles[x, y] = Tile02;
                    else if (isBottom && isLeft)
                        _platformTiles[x, y] = Tile20;
                    else if (isBottom && isRight)
                        _platformTiles[x, y] = Tile22;
                    else if (isTop)
                        _platformTiles[x, y] = Tile01;
                    else if (isBottom)
                        _platformTiles[x, y] = Tile21;
                    else if (isLeft)
                        _platformTiles[x, y] = Tile10;
                    else if (isRight)
                        _platformTiles[x, y] = Tile12;
                    else
                        _platformTiles[x, y] = Tile11;
                }
            }

            // Set width and height based on tile dimensions
            Width = platformWidth * tileSize;
            Height = platformHeight * tileSize;

            Origin = new Vector2(Width, Height) * 0.5f;
        }

        /// <summary>
        /// Initialize the physics body for this platform. Call this after creating the Body in Game1.
        /// </summary>
        public void InitializePhysicsBody(Body physicsBody)
        {
            PhysicsBody = physicsBody;
        }

        public override void Update(GameTime gameTime)
        {
            // Platform is static - sync position from physics body if needed
            // if (PhysicsBody != null)
            // {
            //     Position = new Vector2(
            //         PhysicsBody.Position.X * 100f,
            //         PhysicsBody.Position.Y * 100f
            //     );
            // }
        }

        public override void Draw(SpriteBatch spriteBatch)
        {
            if (_platformTiles == null)
                return;

            for (int x = 0; x < _platformWidth; x++)
            {
                for (int y = 0; y < _platformHeight; y++)
                {
                    int tileType = _platformTiles[x, y];
                    if (tileType == Empty)
                        continue;

                    TextureRegion region = GetTileRegion(tileType);
                    Vector2 tilePosition = Position + new Vector2(x * _tileSize, y * _tileSize);

                    region.Draw(
                        spriteBatch,
                        tilePosition,
                        Color.White,
                        0f,
                        Vector2.Zero,
                        new Vector2(
                            (float)_tileSize / region.Width,
                            (float)_tileSize / region.Height
                        ),
                        SpriteEffects.None,
                        0.0f
                    );
                }
            }
        }

        private TextureRegion GetTileRegion(int tileType)
        {
            return tileType switch
            {
                Tile00 => _tile00,
                Tile01 => _tile01,
                Tile02 => _tile02,
                Tile10 => _tile10,
                Tile11 => _tile11,
                Tile12 => _tile12,
                Tile20 => _tile20,
                Tile21 => _tile21,
                Tile22 => _tile22,
                _ => _tile11,
            };
        }
    }
}
