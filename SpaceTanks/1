using System;
using System.Collections.Generic;
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using Microsoft.Xna.Framework.Input;
using MonoGameLibrary;
using MonoGameLibrary.Graphics;
using nkast.Aether.Physics2D.Dynamics;
using nkast.Aether.Physics2D.Dynamics.Joints;
using AetherVector2 = nkast.Aether.Physics2D.Common.Vector2;

namespace SpaceTanks;

public class Game1 : Core
{
    private GraphicsDeviceManager _graphics;
    private List<Projectile> projectiles = new List<Projectile>();
    private List<GameObject> _gameObjects = new List<GameObject>();
    private List<PhysicsEntity> _bodies = new List<PhysicsEntity>();

    // Physics world
    private World _physicsWorld;
    private bool _debugMode = true;

    public Game1()
        : base("Space Tanks", 1280, 720, false) { }

    protected override void Initialize()
    {
        base.Initialize();

        // Initialize physics world with gravity
        _physicsWorld = new World(new AetherVector2(0, 9.81f));

        // Initialize debug renderers
        AetherBoundsRenderer.Initialize(GraphicsDevice);

        // Initialize game objects
        Tank tank = new Tank(Content);
        tank.Position = new Vector2(300, 0);
        TankPhysics TankPhysics = new TankPhysics();
        TankPhysics.Initialize(_physicsWorld, tank);
        _gameObjects.Add(tank);
        _bodies.Add(TankPhysics);

        Platform platform = new Platform(Content, 30, 6, 32);
        platform.Position = new Vector2(300, 300);
        PlatformPhysics platformPhysics = new PlatformPhysics();
        platformPhysics.Initialize(_physicsWorld, platform);

        _gameObjects.Add(platform);
        _bodies.Add(platformPhysics);
    }

    protected override void LoadContent()
    {
        // Load any additional content here
    }

    protected override void Update(GameTime gameTime)
    {
        Tank tank = (Tank)_gameObjects[0];
        TankPhysics tankBody = (TankPhysics)_bodies[0];
        if (
            GamePad.GetState(PlayerIndex.One).Buttons.Back == ButtonState.Pressed
            || Keyboard.GetState().IsKeyDown(Keys.Escape)
        )
            Exit();

        float deltaTime = (float)gameTime.ElapsedGameTime.TotalSeconds;
        KeyboardState keyboardState = Keyboard.GetState();

        // Tank movement
        if (keyboardState.IsKeyDown(Keys.A))
        {
            tankBody.ApplyForce(new AetherVector2(-5, 0));
        }
        else if (keyboardState.IsKeyDown(Keys.D))
        {
            tankBody.ApplyForce(new AetherVector2(5, 0));
        }
        else
        {
            // Dampen horizontal velocity when no input
            // AetherVector2 currentVelocity = tankBody.LinearVelocity;
            // tankBody.LinearVelocity = new AetherVector2(
            //     currentVelocity.X * 0.8f,
            //     currentVelocity.Y
            // );
        }

        // Gun rotation
        if (keyboardState.IsKeyDown(Keys.Left))
        {
            // tank.RotateGunLeft(deltaTime);
            //
            tankBody.RotateTurret(-1);
        }
        else if (keyboardState.IsKeyDown(Keys.Right))
        {
            // tank.RotateGunLeft(deltaTime);

            tankBody.RotateTurret(1);
        }
        else
        {
            tankBody.StopRotatingTurret();
        }

        // Shooting
        if (keyboardState.IsKeyDown(Keys.Space))
        {
            if (tank.Gun.CanShoot())
            {
                tank.Gun.Shoot();
                Missile projectile = new Missile();
                projectile.Initialize(Content);
                projectile.Position = tank.Gun.Position + new Vector2(0, -tank.Gun.Width - 20f);
                projectile.Rotation = tank.Gun.Rotation;
                ProjectilePhysics projectilePhysics = new ProjectilePhysics();
                projectilePhysics.Initialize(_physicsWorld, projectile);

                projectilePhysics.OnCollision += projectile.HandleCollision;

                // Apply force in the direction the gun is pointing
                float gunAngle = tank.Gun.Rotation;
                float forceStrength = 20f; // Adjust as needed

                AetherVector2 force = new AetherVector2(
                    (float)System.Math.Cos(tank.Gun.Rotation) * forceStrength,
                    (float)System.Math.Sin(tank.Gun.Rotation) * forceStrength
                );

                projectilePhysics.Body.Rotation = tank.Gun.Rotation;
                // projectilePhysics.Body.ApplyForce(force);

                // Auto-spin based on velocity
                // The faster it moves, the faster it spins
                // float speed = projectilePhysics.Body.LinearVelocity.Length();
                // projectilePhysics.Body.AngularVelocity = speed * 20f; // Adjust multiplier to taste
                //
                _gameObjects.Add(projectile);
                _bodies.Add(projectilePhysics);
            }

            //
            // AetherVector2 physicsPos = new AetherVector2(
            //     projectile.Position.X / 100f,
            //     projectile.Position.Y / 100f
            // );
            //
            // Body body = _physicsWorld.CreateBody(physicsPos, 0, BodyType.Dynamic);
            // var fixture = body.CreateRectangle(
            //     projectile.Width / 100f,
            //     projectile.Height / 100f,
            //     1,
            //     AetherVector2.Zero
            // );
            // fixture.Friction = 0.5f;
            // fixture.Restitution = 0.1f;
            // _bodies.Add(projectilePhysics);
            // if (projectile != null)
            // {
            //     projectiles.Add(projectile);
            // }
        }

        // Update physics world
        _physicsWorld.Step(deltaTime);

        for (int i = 0; i < _bodies.Count; i++)
        {
            if (_gameObjects.Destroyed)
            {
                _bodies[i].RemoveAt(i);
                _gameObjects[i].RemoveAt(i);
            }
            _bodies[i].Sync(_gameObjects[i]);
            _gameObjects[i].Update(gameTime);
        }

        base.Update(gameTime);
    }

    protected override void Draw(GameTime gameTime)
    {
        GraphicsDevice.Clear(Color.CornflowerBlue);
        SpriteBatch.Begin(samplerState: SamplerState.PointClamp);

        foreach (GameObject gameObject in _gameObjects)
        {
            gameObject.Draw(SpriteBatch);
        }

        // Draw physics bounds - toggle with 'D' key
        if (_debugMode)
        {
            AetherBoundsRenderer.DrawWorldAABBs(
                SpriteBatch,
                _physicsWorld,
                Color.Orange,
                Color.Green
            );
            foreach (PhysicsEntity body in _bodies) { }
        }

        SpriteBatch.End();
        base.Draw(gameTime);
    }
}
